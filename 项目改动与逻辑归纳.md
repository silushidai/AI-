# DeepSeek 思维链对话 — 项目改动与逻辑归纳

> 用于后续提问 AI 时快速回忆项目状态与流程，便于继续开发。

---

## 一、已完成的改动汇总

### 1. 基础功能

| 改动 | 说明 |
|------|------|
| 双模式 | DeepSeek API（云端）、Ollama 本地 |
| API Key 设置 | 双击「DeepSeek API（云端）」弹出输入窗口 |
| 思维链流程图 | 展示、缩放、双击节点看全文；回复后先显示「正在生成专业流程图…」，等专业流程图生成后再显示，避免先显示简单流程图；生成期间禁用交互模式 |
| 界面风格 | 主窗口与交互窗口均有「界面风格」按钮，可切换深邃墨色/清新浅色/暖调舒适，保存后立即生效；配置存于 外置记忆/界面风格配置.json |
| 提取按钮 | 流程图旁「提取」，将内容以可复制文本形式输出 |
| 交互模式 | 基于思维链追问，流程图扩展 |
| 继续交互 | 高亮节点数 +1，深入追问；**全亮时禁用** |

### 2. AI 外置记忆循环结构（参考 ai编程.pdf）

| 改动 | 说明 |
|------|------|
| 外置记忆 JSON | `外置记忆/思路存储器.json`，双层：call_sequence + nodes |
| 保存/加载按钮 | 主窗口：保存外置记忆、加载外置记忆 |
| 自动保存 | 每次对话、流程图更新、交互发送后自动写入 JSON |

### 3. 单思路结点动态更新

| 改动 | 说明 |
|------|------|
| 交互模式两次调用 | 用户发送时：第一次正常对话（问什么答什么），第二次后台思维链续写+流程图JSON；流程图更新完成前禁用「发送」和「继续交互」 |

### 4. 数据库存储（MySQL/MariaDB）

| 改动 | 说明 |
|------|------|
| 三张表 | `flowchart_content`、`flowchart_session`、`retrieval_label` |
| 结点去重 | 相同 content+node_type 只存一次，通过 node_sequence 引用；从数据库加载的结点带 db_content_id，再保存时直接复用，减少 SELECT |
| 检索标签 | label_text 可按配置自定义；检索超时可配置，超时后回退字符串检索，无匹配则提示 |
| 自动触发 | 仅在**交互模式**、**流程图全亮**时后台自动写入数据库 |
| 全亮禁用继续交互 | 全亮后「继续交互」按钮被禁用 |

### 5. 加载外置记忆（双通道）

| 改动 | 说明 |
|------|------|
| 检索并加载 | 输入检索描述 → AI 匹配 retrieval_label 全表 → 返回 session_id → 加载流程图 |
| 从 JSON 加载 | 从 `外置记忆/思路存储器.json` 恢复 |
| 全表匹配 | 模型需阅读 retrieval_label 中**全部** id 对应的 label_text 后再选择 session_id |

---

## 二、加载外置记忆逻辑流程

### 2.1 从数据库检索并加载（主流程）

```
用户点击「加载外置记忆」
    ↓
弹出检索窗口，用户输入检索描述（如「上次的算法推导」）
    ↓
用户点击「检索并加载（从数据库）」
    ↓
1. 查询 retrieval_label 全表：SELECT id, session_id, label_text FROM retrieval_label ORDER BY id ASC
    ↓
2. 构造 prompt：展示 全部 id、session_id、label_text（完整内容），强调「必须完整阅读所有 id 对应的 label_text 后再决定」
    ↓
3. 调用 AI 模型：用户描述 + 全部选项 → 模型返回最匹配的 session_id（有超时限制，超时后回退字符串检索）
    ↓
4. 根据 session_id 查询 flowchart_session 的 node_sequence
    ↓
5. 按 node_sequence 中的 id 顺序，从 flowchart_content 取出 content、node_type，并将 id 存为 db_content_id
    ↓
6. 重构 flow_steps、flow_spec（节点含 db_content_id），回调 on_loaded 加载到主窗口
    ↓
完成
```

### 2.2 从 JSON 文件加载

```
用户点击「从 JSON 文件加载」
    ↓
读取 外置记忆/思路存储器.json
    ↓
解析 nodes、edges、flow_steps、messages
    ↓
恢复 flow_steps、flow_spec、messages 到主窗口
```

---

## 三、存储思维链流程图逻辑流程

### 3.1 JSON 外置记忆（每次更新都执行）

```
触发：主窗口发送、专业流程图生成、交互模式每次发送
    ↓
_save_external_memory(flow_steps, flow_spec, messages)
    ↓
写入 外置记忆/思路存储器.json
结构：{ call_sequence, nodes, edges, flow_steps, messages, version, updated_at }
```

### 3.2 数据库存储（仅交互模式 + 全亮时）

```
触发条件：交互模式 且 流程图全亮（num_bright >= 总节点数）
    ↓
_save_to_database(flow_steps, flow_spec, mode, model_name, ollama_model=...)
    ↓
1. 遍历当前所有结点
    ↓
2. 对每个结点：
   - 若有 db_content_id（从数据库加载且未交互更新）→ 直接复用，不查库
   - 若无 → _get_or_insert_content_id
     SELECT id FROM flowchart_content WHERE content=? AND node_type=?
     若存在 → 复用 id；若不存在 → INSERT 并返回新 id
    ↓
3. 构造 node_sequence = [id1, id2, ...]
    ↓
4. INSERT flowchart_session (mode, model_name, summary, node_sequence)
    ↓
5. 生成检索标签
   - raw_label = _build_retrieval_label(nodes_data)
     （开头结点后内容 | 结束结点前内容，各取前 300 字）
   - label_text = _format_retrieval_label_via_ai(raw_label, mode, ollama_model)
     （调用 AI 格式化为「开头内容、最终结果、最终目的」）
   - 若 AI 失败，用 raw_label 前 500 字
    ↓
6. INSERT retrieval_label (session_id, label_text)
    ↓
完成（后台线程执行，不阻塞 UI）
```

---

## 四、数据库表结构速查

| 表 | 字段 | 说明 |
|----|------|------|
| flowchart_content | id, content, node_type, created_at | 结点内容去重库 |
| flowchart_session | id, created_at, mode, model_name, summary, node_sequence(JSON) | 会话，node_sequence 为 flowchart_content.id 的有序列表 |
| retrieval_label | id, session_id, label_text, created_at | 检索标签，session_id 外键指向 flowchart_session |

---

## 五、关键文件与配置

| 文件 | 用途 |
|------|------|
| deepseek_chat_app.py | 主程序 |
| 建库SQL.sql | 建库建表 |
| 清空表数据.sql | 清空三张表数据 |
| 数据库连接配置.txt | _DB_CONFIG 说明 |
| 外置记忆/思路存储器.json | JSON 存储路径 |
| 外置记忆/检索标签格式配置.json | label_text 存储格式与参考结点位置配置（可点击「检索标签格式」修改） |

| 配置 | 位置 |
|------|------|
| _DB_CONFIG | deepseek_chat_app.py 约 53-60 行 |
| _EXTERNAL_MEMORY_FILE | 外置记忆/思路存储器.json |

---

## 六、依赖

```
requests>=2.28.0
pymysql>=1.0.0
```

---

## 七、核心函数索引

| 函数 | 作用 |
|------|------|
| _save_external_memory | 写 JSON 外置记忆 |
| _load_external_memory | 读 JSON 外置记忆 |
| _save_to_database | 全亮时写数据库（label_text 按配置格式化） |
| _load_from_database_by_query | 用户输入 + AI 匹配 + 加载流程图 |
| _build_retrieval_label | 生成原始标签（从流程图结点取内容，受配置控制） |
| _apply_label_text_format | 将 raw_label 转为 label_text（ai/raw/custom，受配置控制） |
| _load_label_text_config / _save_label_text_config | 检索标签格式配置的加载与保存 |
| _show_label_text_config_window | 检索标签格式设置弹窗 |
| _get_or_insert_content_id | 结点去重，返回 id |
| _is_flowchart_fully_bright | 判断是否全亮 |
| _refine_last_node_by_interaction | 单思路结点动态更新 |
| update_continue_btn_state | 全亮时禁用「继续交互」 |
